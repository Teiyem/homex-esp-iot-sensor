# Homex Esp IoT Sensor
Temperature and humidity IoT device based on the ESP8266 RTOS SDK.

## Getting started
There are two files in the data folder that shows the initial json data that will be written to the storage as can be seen here in the [write function](https://github.com/Teiyem/homex-esp-iot-sensor/blob/7c0f2f919db802ab5af5338eb3809bb50d2c9bf8/components/device/device.cpp#L604).
I couldn't manage to use any spiffs uploader tool, so I use that function to write the one time data.
* Uncomment the line where the [write function is called](https://github.com/Teiyem/homex-esp-iot-sensor/blob/7c0f2f919db802ab5af5338eb3809bb50d2c9bf8/components/device/device.cpp#L745).
* Upload the code and comment the line back and upload again.
* The sc_key is used for smart config and the crypt_key is used for encryption and decryption.

## Workflow
* The device will be in setup mode (running smart config).
* The device receives wifi credentials via smart config, as well as the device's friendly name and host (server) IP address from the user-defined reserved data.
* After smart config is completed, the device will restart.
* When the device connects to WiFi, it will attempt to obtain an API key from the server.
* After retrieving the key, the device will send sensor data to the server on a regular basis (every 6 minutes).
* The device will host a web server from which device's information, configuration, and sensor data can be retrieved.

## Features
* Http client
* Http server
* Smart Config (ESP Touch V2)
* Ota

## Current Configuration
* DHT22 Connected to GPIO 4 (D2)
* NodeMCU 1.0 (ESP-12E Module)
* local hosted http server.

## Project Configuration
* ESP8266 RTOS SDK v3.4
* Toolchain v8.4.0
* VS Code v1.68.1
* Ubuntu 22.04 LTS

## Supported sensors
* DHT11
* DHT22
* SI7021

## Led Indicator
* Static - The device is connected to the wifi
* Fast Blink - The device is running smart config
* Slow Blink - The device is either disconnected or not connected to the wifi

## Note
* The log level is set to verbose, and wifi logging is enabled in the provided sdkconfig; like the project logging, it is only used for debugging.
* The partition table is configured for a 4MB module; modify the sdkconfig and partition table accordingly.
* The device expects the user-defined data from smart config to be in JSON format, e.g {"name": "", "host": ""}
* Because the ESPTOUCH APP from the app store does not presently support ESP-Touch-V2, you will need to compile and run the source code on a physical device. The source code can be accessed in the Resources section.
* The external server does the majority of the heavy lifting in terms of the simple implemented security. 
* The device relies on the api key generated by the server to validate requests made to it; however, if the device is unable to retrieve the api, a hardcoded unique key will be used instead.
* This code is functional as is. I'm far from a pro or an expert. Please keep the known issues in mind when making changes to the code or copying it to your own project.
* This is v1, so there is still plenty of space for improvements.

## Known Issues
* Using cJSON_AddNumberToObject while "nano formatting options for printf/scanf family" is enabled causes a LoadStoreAlignmentCause abort. It's disabled in the provided sdkconfig.
* Setting the http client Content-Type header to application/json causes the esp_http_client_perform to return an error of ESP_ERR_HTTP_FETCH_HEADER, but the data is received on the client, so I treat that error as a success because the client doesn't send back any data to the device. The only disadvantage is we don't know if we received the correct status code. A workaround would be to not use application/json and instead use the default application/x-www-form-urlencoded and parse the content on the client. I haven't discovered a solution yet, but perhaps you can. 
* Creating static variables in class functions that are called from RTOS tasks results in a LoadStoreAlignmentCause abort, thus I avoided doing so. Furthermore, some boolean values were set to true but were initially set to false, thus I used for atomic variables for those variables. This is most likely due to the way I wrote the code.

## Resources
* [SDK Docs](https://docs.espressif.com/projects/esp8266-rtos-sdk/en/latest/get-started/index.html)
* [ESPTOUCH Android source code](https://github.com/EspressifApp/EsptouchForAndroid)
* [ESPTOUCH iOS source code](https://github.com/EspressifApp/EsptouchForIOS)

Happy coding!